<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EPICKART — Demo Store (Functional)</title>
<style>
:root{--primary:#2874f0;--accent:#ff3b30;--bg:#f4f6fb}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#111}
.header{background:var(--primary);color:#fff;padding:12px;display:flex;align-items:center;gap:12px}
.header .brand{font-weight:800}
.container{max-width:1100px;margin:12px auto;padding:12px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:#fff;padding:12px;border-radius:8px}
.card img{width:100%;height:160px;object-fit:cover;border-radius:6px}
.btn{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.side{background:#fff;padding:12px;border-radius:8px}
.small{font-size:13px;color:#666}
@media(max-width:600px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="header">
  <div class="brand">EPICKART</div>
  <div style="flex:1"></div>
  <div id="cartCount">Cart: 0</div>
</div>

<div class="container">
  <div style="display:flex;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:300px">
      <h3>Products</h3>
      <div id="productGrid" class="grid"></div>
    </div>

    <div style="width:320px;min-width:260px">
      <div class="side">
        <h4>Cart</h4>
        <div id="cartItems"></div>
        <div id="cartTotal" class="small" style="margin-top:10px">Total: ₹0</div>
        <button class="btn btn-primary" onclick="checkout()">Checkout</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const BACKEND_BASE_URL = '<REPLACE_BACKEND_URL>';
const RAZORPAY_KEY_ID = '<REPLACE_RAZORPAY_KEY_ID>';
const EMAILJS_PUBLIC_KEY = '<REPLACE_EMAILJS_PUBLIC_KEY>';
const EMAILJS_SERVICE = 'service_zidiq5q';
const EMAILJS_TEMPLATE_CUSTOMER = 'template_ki36d0b';
const EMAILJS_TEMPLATE_ADMIN = 'template_nn3hwzs';

if (typeof emailjs !== 'undefined' && EMAILJS_PUBLIC_KEY && !EMAILJS_PUBLIC_KEY.includes('<REPLACE')) {
  try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e){ console.warn('EmailJS init failed', e); }
}

let PRODUCTS = [];
fetch('products.json').then(r=>r.json()).then(data=>{ PRODUCTS = data; renderProducts(); updateCartUI(); }).catch(()=>{
  PRODUCTS = [
    {id:1,name:'Beauty Serum',price:799,img:'https://picsum.photos/seed/p1/600/400',desc:'Hydrating serum',cod:true},
    {id:2,name:'Lipstick Pack',price:299,img:'https://picsum.photos/seed/p2/600/400',desc:'Matte finish',cod:true},
    {id:3,name:'Cotton Dress',price:1299,img:'https://picsum.photos/seed/p3/600/400',desc:'Comfortable',cod:false},
    {id:4,name:'Wireless Earbuds',price:1999,img:'https://picsum.photos/seed/p4/600/400',desc:'Long battery',cod:false}
  ];
  renderProducts(); updateCartUI();
});

let CART = JSON.parse(localStorage.getItem('ep_cart')||'[]');

function renderProducts(){
  const grid = document.getElementById('productGrid'); grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const c = document.createElement('div'); c.className='card';
    c.innerHTML = `
      <img src="${p.img}" alt="${p.name}">
      <h4>${p.name}</h4>
      <div class="small">${p.desc || ''}</div>
      <div style="margin-top:8px;font-weight:800">₹${p.price}</div>
      <div style="margin-top:8px"><button class="btn" onclick="viewProduct(${p.id})">View</button> <button class="btn btn-primary" onclick="addToCart(${p.id})">Add</button></div>
    `;
    grid.appendChild(c);
  });
}

function updateCartUI(){
  localStorage.setItem('ep_cart', JSON.stringify(CART));
  document.getElementById('cartCount').textContent = 'Cart: ' + CART.reduce((s,i)=>s+i.qty,0);
  const box = document.getElementById('cartItems'); box.innerHTML='';
  let total = 0;
  CART.forEach(it=>{
    const p = PRODUCTS.find(x=>x.id===it.id); if(!p) return;
    total += p.price * it.qty;
    const row = document.createElement('div'); row.className='small'; row.style.marginBottom='6px';
    row.innerHTML = `<strong>${p.name}</strong><div>₹${p.price} x ${it.qty}</div>`;
    box.appendChild(row);
  });
  document.getElementById('cartTotal').textContent = 'Total: ₹' + total;
}
function addToCart(id){ const item = CART.find(x=>x.id===id); if(item) item.qty++; else CART.push({id,qty:1}); updateCartUI(); alert('Added to cart'); }
function viewProduct(id){ const p = PRODUCTS.find(x=>x.id===id); if(!p) return alert('Product not found'); if(confirm(`Buy ${p.name} for ₹${p.price}? OK=Buy Now, Cancel=Add to Cart`)){ buyNow(p.id); } else { addToCart(p.id); } }

async function checkout(){
  if (CART.length===0) return alert('Cart empty');
  const name = prompt('Full name'); const email = prompt('Email'); const address = prompt('Shipping address');
  if(!name||!email||!address) return alert('All details required');
  const items = CART.map(it=>{ const p = PRODUCTS.find(x=>x.id===it.id); return { id:p.id, name:p.name, price:p.price, qty:it.qty, cod:p.cod, img:p.img }; });
  const total = items.reduce((s,i)=>s + i.price * i.qty, 0);
  const allCOD = items.every(i=>i.cod);
  let payment_option = 'online';
  if(allCOD && confirm('Do you want Cash on Delivery instead of online payment?')) payment_option = 'cod';

  if(payment_option === 'online'){
    if(!BACKEND_BASE_URL || BACKEND_BASE_URL.includes('<REPLACE')) return alert('Backend URL not configured in index.html');
    const resp = await fetch(BACKEND_BASE_URL + '/create-order', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: total }) });
    const data = await resp.json();
    if(!data || !data.order) return alert('Failed to create order: ' + JSON.stringify(data));
    const rorder = data.order;
    const options = {
      key: RAZORPAY_KEY_ID,
      amount: rorder.amount,
      currency: rorder.currency,
      name: "EPICKART",
      description: "Order " + rorder.id,
      order_id: rorder.id,
      handler: async function (res){
        const verifyResp = await fetch(BACKEND_BASE_URL + '/verify-payment', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ razorpay_order_id: res.razorpay_order_id, razorpay_payment_id: res.razorpay_payment_id, razorpay_signature: res.razorpay_signature })
        });
        const verifyData = await verifyResp.json();
        if(verifyData && verifyData.verified){
          const orderObj = { id: rorder.id, items, total, payment_method:'Online', customer_name:name, customer_email:email, address, created: new Date().toISOString(), payment_id: res.razorpay_payment_id };
          saveOrderLocally(orderObj); sendEmails(orderObj); CART=[]; updateCartUI(); alert('Payment successful! Order placed: ' + orderObj.id);
        } else { alert('Payment verification failed'); }
      },
      prefill: { name, email },
      theme: { color: "#2874f0" }
    };
    const rzp = new Razorpay(options); rzp.open();
  } else {
    const orderObj = { id:'COD'+Date.now(), items, total, payment_method:'COD', customer_name:name, customer_email:email, address, created: new Date().toISOString() };
    saveOrderLocally(orderObj); sendEmails(orderObj); CART=[]; updateCartUI(); alert('Order placed (COD). Order ID: ' + orderObj.id);
  }
}

function saveOrderLocally(order){ const ORDERS = JSON.parse(localStorage.getItem('ep_orders')||'[]'); ORDERS.push(order); localStorage.setItem('ep_orders', JSON.stringify(ORDERS)); }

function sendEmails(order){
  if(typeof emailjs === 'undefined' || EMAILJS_PUBLIC_KEY.includes('<REPLACE')){ console.warn('EmailJS not configured'); return; }
  const product_rows = order.items.map(it=>`${it.name} x ${it.qty} — ₹${it.price * it.qty}`).join('\n');
  const customerPayload = { customer_name: order.customer_name, order_id: order.id, order_date: new Date(order.created).toLocaleString(), payment_method: order.payment_method, product_rows, total: order.total, address: order.address, order_link: window.location.href };
  emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE_CUSTOMER, customerPayload).then(()=>console.log('Customer email sent')).catch(e=>console.warn(e));
  const adminPayload = Object.assign({}, customerPayload, { admin_note:'New order' });
  emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE_ADMIN, adminPayload).then(()=>console.log('Admin email sent')).catch(e=>console.warn(e));
}

</script>
</body>
</html>
